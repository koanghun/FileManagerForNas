# 개발일지: 2025-11-12

## 완료된 작업

### 1. AI 스마트 검색 프론트엔드 UI 통합

백엔드에 구현된 AI 기반 스마트 검색 기능을 프론트엔드와 연동하여 사용자가 직접 자연어 검색을 수행하고 결과를 확인할 수 있도록 UI를 구현했습니다.

-   **`SearchBar.tsx` 컴포넌트 신규 생성:**
    -   사용자가 검색어를 입력하고 실행할 수 있는 검색창 UI를 구현했습니다.
    -   검색 중에는 입력 필드와 버튼이 비활성화되어 중복 요청을 방지합니다.
-   **`SearchResults.tsx` 컴포넌트 신규 생성:**
    -   검색 결과를 목록 형태로 표시하는 UI를 구현했습니다.
    -   각 결과 항목에는 원본 파일 경로, 검색된 내용의 일부(snippet), 그리고 검색어와의 유사도 점수가 표시됩니다.
    -   '파일 목록으로 돌아가기' 버튼을 통해 일반 파일 탐색기 뷰로 전환할 수 있습니다.
-   **`App.tsx` 상태 관리 로직 추가:**
    -   `viewMode` 상태를 추가하여 '파일 탐색' 모드와 '검색 결과' 모드를 전환할 수 있도록 구현했습니다.
    -   `searchQuery`, `searchResults`, `isSearching` 등의 상태를 추가하여 검색 기능의 전체 흐름을 관리합니다.
    -   `/api/search` 엔드포인트를 호출하는 `handleSearch` 이벤트 핸들러를 구현했습니다.

### 2. 폴더 단위 인덱싱 기능 구현

사용자가 UI에서 직접 특정 폴더를 지정하여 인덱싱을 수행하고, 폴더별 인덱싱 상태를 시각적으로 확인할 수 있는 기능을 백엔드와 프론트엔드에 걸쳐 구현했습니다.

-   **백엔드:**
    -   **`index_manager.py` 및 SQLite DB 추가:**
        -   폴더의 인덱싱 상태(`indexed`, `not_indexed`, `outdated` 등)와 마지막 인덱싱 시간 등을 기록하고 관리하기 위한 `IndexManager` 서비스와 `index_metadata.db` SQLite 데이터베이스를 도입했습니다.
    -   **신규 API 엔드포인트 추가:**
        -   `POST /api/index/folder`: 특정 폴더의 인덱싱을 백그라운드에서 시작합니다.
        -   `POST /api/index/status`: 여러 폴더의 현재 인덱싱 상태를 한 번에 조회합니다.
        -   `DELETE /api/index/folder`: 특정 폴더의 인덱스 데이터를 DB와 벡터 DB 양쪽에서 모두 삭제합니다.
    -   **Provider 기능 확장:**
        -   `FileSystemProvider` 인터페이스에 `get_metadata`, `read_file_content`, `list_files_recursive` 추상 메서드를 추가했습니다.
        -   `LocalProvider`와 `SynologyAPIProvider`에 위 신규 메서드들을 모두 구현하여, 재귀적 파일 탐색, 파일 내용 읽기, 메타데이터 조회 기능을 제공하도록 확장했습니다.

-   **프론트엔드:**
    -   **`FileItem.tsx` UI 개선:**
        -   폴더 아이템에 인덱싱 상태를 나타내는 **색상 점(Status Indicator)**을 추가했습니다. (초록: `indexed`, 빨강: `not_indexed`, 주황: `outdated`, 파랑(점멸): `indexing`)
        -   상태에 따라 'Index', 'Re-index', 'Delete Index' 등 **액션 버튼**이 조건부로 렌더링되도록 구현했습니다.
    -   **`App.tsx` 로직 추가:**
        -   `folderStatuses` 상태를 추가하여 폴더별 인덱싱 상태를 관리합니다.
        -   파일 목록을 불러온 후, `useEffect` 내에서 `/api/index/status` API를 호출하여 각 폴더의 상태를 가져와 UI에 반영하도록 구현했습니다.
        -   `handleIndexFolder`, `handleDeleteIndex` 핸들러를 구현하여 각 액션 버튼과 API를 연동했습니다.

### 3. 주요 버그 수정 및 기능 개선

사용자 피드백을 바탕으로 시스템의 여러 문제점을 해결하고 안정성을 향상했습니다.

-   **문제 1: 재로그인 시 인덱싱 상태 초기화**
    -   **원인:** 로그인 시마다 새로 생성되는 세션 토큰을 기반으로 인덱싱 상태를 저장하여, 재로그인 시 이전 상태를 불러오지 못했습니다.
    -   **해결:** 인덱싱 상태를 식별하는 `provider_id`를 '호스트 주소 + 사용자 이름'의 조합으로 생성하여, 로그인 세션과 무관하게 인덱싱 상태가 영구적으로 유지되도록 백엔드 인증 로직을 수정했습니다.

-   **문제 2: 인덱싱 완료 후 UI 자동 갱신 안 됨**
    -   **원인:** `setTimeout`을 사용한 일회성 상태 조회 로직으로 인해, 인덱싱 작업이 5초 이상 걸릴 경우 UI가 갱신되지 않았습니다.
    -   **해결:** `handleIndexFolder` 함수에 `setInterval`을 사용한 폴링(polling) 메커니즘을 도입했습니다. 인덱싱 시작 후, 해당 폴더의 상태가 'indexing'이 아닐 때까지 3초마다 상태를 자동으로 다시 조회하여 작업 완료 즉시 UI가 갱신되도록 수정했습니다.

-   **문제 3: 검색 결과의 정확도 부족 및 다양성 부재**
    -   **원인:** 책 한 권 전체를 단일 벡터로 임베딩하여, 세부 내용이 평균화되고 검색 시 특정 문맥을 정확히 찾아내지 못했습니다.
    -   **해결 (Overlapping Chunking 도입):**
        -   파일 전체를 통째로 인덱싱하는 대신, 내용을 **일정 크기(500자)로 나누고, 각 경계에서 내용이 겹치도록(50자)** 잘게 쪼개는 'Overlapping Chunking' 전략을 도입했습니다.
        -   `main.py`에 `chunk_text` 헬퍼 함수를 구현하고, `do_index_folder` 작업이 이 함수를 사용해 텍스트를 분할하도록 수정했습니다.
        -   `search_service.py`의 인덱싱 메서드를 단일 파일 처리에서 여러 청크를 일괄 처리하는 `index_chunks`로 변경하여 효율성을 높였습니다.
        -   이로써 검색 시 더 구체적이고 문맥에 맞는 '쪽(chunk)' 단위의 결과를 반환하여 정확도와 다양성을 크게 향상했습니다.

-   **문제 4: 검색 결과의 텍스트 깨짐 현상**
    -   **원인:** `UTF-8`로 인코딩되지 않은 파일(예: `EUC-KR`)을 읽을 때 글자가 깨졌습니다.
    -   **해결:** `synology.py`의 `read_file_content` 메서드를 수정하여, `UTF-8`로 디코딩을 먼저 시도하고 실패할 경우, 한국어 `euc-kr`, 일본어 `shift_jis` 순서로 다시 디코딩을 시도하도록 로직을 추가하여 다중 인코딩을 지원하도록 개선했습니다.

-   **문제 5: AI 모델의 한국어 처리 성능**
    -   **원인:** 기존의 영어 중심 모델(`all-MiniLM-L6-v2`)이 한국어 검색에 최적화되지 않았습니다.
    -   **해결:** 한국어, 일본어, 영어를 포함한 50개 이상의 언어를 지원하는 다국어 모델 `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`로 교체하여 검색 품질을 향상했습니다.

-   **기타 디버깅 및 안정성 개선:**
    -   DB 초기화 후 인덱싱된 파일이 없을 때 오류가 발생하는 문제를 해결했습니다. (`search_service.py`)
    -   디버깅을 위해 인덱싱된 모든 파일 목록을 보여주는 `/api/debug/indexed-files`와 벡터 DB를 초기화하는 `/api/debug/reset-db` 엔드포인트를 추가했습니다.


